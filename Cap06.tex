\chapter[Capítulo 6. Pruebas de Funcionamiento]{Pruebas de Funcionamiento}

\section{Simulador SAE J1939}

El Au-SAE J1939 simulador Ver 2.00A es un dispositivo capaz de proveer la mayoría de las señales de la norma SAE J1939. Una topología de red típica SAE J1939 se ilustra en la \textbf{Figura \ref{TPSAE}}.

\begin{figure}[H]
	\centering
		\includegraphics[width=0.8\textwidth]{./Cap6imagen/EjemploSimulador.pdf}
	\caption[Topología de Red SAE J1939.]{Topología de Red SAE J1939.\textbf{ Fuente:} \cite{UserM}.}
	\label{TPSAE} % Etiqueta para la referencia.
\end{figure}

Existen 6 ediciones del simulador  Gen II SAE J1939 de la \textbf{Figura \ref{Sim}}, que son proporcionados por Electrónica Au Grup para satisfacer las necesidades según los diferentes usuarios: 

\begin{figure}[H]
	\centering
		\includegraphics[width=0.8\textwidth]{./Cap6imagen/Simulador.png}
	\caption[Simulador BUS CAN SAE J1939.]{Simulador BUS CAN SAE J1939.\textbf{ Fuente:} \cite{UserM}.}
	\label{Sim} % Etiqueta para la referencia.
\end{figure}


\begin {itemize}
  
    \item Simulador Gen II  SAE-J1939  - Engine Basic Edition
	\item Simulador Gen II  SAE-J1939  - Engine Basic Plus Edition
	\item Simulador Gen II  SAE-J1939  - Engine Premium Edition
	\item Simulador Gen II  SAE-J1939  - Engine Premium Plus Edition
	\item Simulador Gen II  SAE-J1939  - Vehicle Platinum Edition
	\item Simulador Gen II  SAE-J1939  - Vehicle Platinum Plus Edition

\end{itemize}

Las ediciones "Plus" tienen todas las funciones de las ediciones "no-Plus", además de un programa de ordenador de terminal remota que puede ser utilizado para controlar y visualizar los datos SAE J1939 en la pantalla del PC. Además un conjunto de herramientas de gestión de licencias proporciona la capacidad de actualizar el simulador de edición básica de edición premium / platino. "Non-Plus" edición es capaz de ser actualizado a las ediciones "Plus".

\begin{itemize}
\item Engine Basic Edition: Genera la mayor parte de los datos básicos del motor de manera "Estática" o "Dinámica". Los dos botones (Up y Down) se utilizan para ajustar la salida de datos del simulador en el "modo estático" o en el "modo dinámico" respectivamente.En el "modo dinámico" los datos cambian de forma automática según los intervalos de valores estándares para el SAE  J1939. Los LEDs indican el valor del paso de control de la señal de salida, tiene un zumbador que indica el cambio de estado del simulador e indica el encendido del mismo.
\item Motor Premium Edition:
Incluye todas las funciones del motor Basic Edition e Incluye características premium de diagnosis del vehículo denominado DM1 (Diagnostics Message 1, por sus siglas en inglés),  DM2 y DM3 los cuales son parámetros que diagnostican el estado del vehículo.

\item Vehicle Platinum Edition: Incluye todas las funciones del motor Premium Edition, además incluye funciones que involucran la red interna del vehículo,  Señales relacionadas con el ABS (Antiblockiersystem), señales relacionadas con la transmisión y señales relacionadas con la Configuración del motor, \cite{UserM}.

\end{itemize}

\subsection {Principales Características del Simulador}

\begin{itemize}

\item Contiene una resistencia de carga interna 120 ohmios para montar una red BUS CAN.
\item Protección con  TVS (Transient Voltage Suppressor, por sus siglas en ingles) para protección contra altos niveles de tensión. 
\item Tamaño compacto.
\item 9 Indicadores LED: Encendido, Rando y Advertencia, HASTA 100\%, frente a 0\%, 80\%, 60\%, 40\%, 20\%, el  LED parpadeará cuando se selecciona uno de estos seis valores especificados.
\item Color de la carcasa: Negro 
\item 1 Zumbador
\item 3 botones: MENU, DOWN, UP, la señal J1939 se puede ajustar a través de estos pulsadores.
\item 1 interfaz RS232 para la actualización de software, gestión de licencias y control remoto.
\item 1 conector DB9 macho para la alimentación y la conexión CANH - CANL.
\item Fuente de alimentación: 9 a 12 VDC, 250mA máximo.
\item Temperatura de funcionamiento: -20$^{\circ}$C a 85$^{\circ}$C

\end{itemize}

\subsection{Modo de Funcionamiento}

Las simulaciones pueden ser operadas con sólo el control de los 3 botones presentes en el equipo. Con la configuración guiada por estos botones se genera una señal SAE J1939 para su uso en desarrollos de sistemas BUS CAN para camiones.

El equipo debe conectarse a una fuente externa entre 9-12 V. La alimentación se realiza con los pines 1 (Tierra) y 5 (Potencial positivo), la conexión del BUS CAN tanto CANH como CANL se realiza en los pines 6 y 7 como se muestra en la \textbf{Figura \ref{DB9}}.  El indicador LED de encendido se ilumina y al estar listo el equipo emite un sonido a través del zumbador, entonces el simulador Au SAE J1939 empieza a funcionar en el modo (estático o dinámico) guardado en la última vez de su funcionamiento.

\begin{figure}[H]
	\centering
		\includegraphics[width=0.8\textwidth]{./Cap6imagen/SimDb9.pdf}
	\caption[Conector DB9 macho BUS CAN.]{Conector DB9 macho BUS CAN.\textbf{ Fuente:} \cite{UserM}.}
	\label{DB9} % Etiqueta para la referencia.
\end{figure}

El modo estático genera una señal SAE J1939 constante, los  dos pulsadores (Up y Down) se utiliza para cambiar las salidas de datos mediante la decisión del usuario. En el modo dinámico todos los datos SAE-J1939 cambian automáticamente sin que el rango de valores sea intervenido por el usuario del equipo. Para Pasar de un modo de funcionamiento a otro se presiona los botones MENU y UP al mismo tiempo durante más de 1 segundo, es decir, para cambiar entre el modo dinámico y el modo estático. Una vez realizado, la confirmación del cambio se detecta con un zumbido del equipo.

En el modo estático el botón Down se utiliza para decrementar los valores de las señales SAE-J1939 presentes en las salidas del BUS CAN. Los leds muestran el descenso de las señales de manera porcentual, de la misma manera el botón Up se utiliza para aumentar los valores de las señales SAE-J1939 y los leds muestran el aumento de las señales de manera porcentual. la manera de cambiar entre estos dos modos se realiza presionando al mismo tiempo los botones MENÚ y UP por más de un segundo, de esta manera se intercala entre los modos de funcionamiento estático y dinámico. Un pitido largo será oído para reflejar la entrada de la tecla MENU y UP.

A modo de resumen se indica las funciones básicas de los botones:
\begin{itemize}
\item Botón DOWN: permite disminuir todos los datos simulados hasta que alcanza el valor más bajo.
 \item botón UP: permite aumentar todos los datos simulados hasta que alcanza el valor más alto.
\item botón MENÚ: activa y desactiva el DM1, esta opción no esta disponible en la versión básica.
\item Mantener presionado el botón MENÚ cuando se enciende: el simulador entrará en modo BootLoader, si no se detecta ninguna comunicación de un programa Bootloader del PC en 10 segundos, se reanudará en modo normal.
 \item DoWN + UP: activa y desactiva el Control de alarma.
\item MENÚ + UP: Cambia el funcionamiento del simulador entre el modo estático y dinámico.
\item MENU + DOWN: activa y desactiva el DM2 (Diagnostics Message 2, por sus siglas en inglés), esta opción no esta disponible en la versión básica.
\end{itemize}


	
\subsection{Medición de las Pruebas Realizadas}
Se realiza una prueba con el simulador y para ello conectamos un bus entre el hardware y el simulador J1939, alimentados ambos por una fuente de tensión de 12v. Como se observa en la \textbf{Figura \ref{simulador_ref_c6}}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\textwidth]{./Cap6imagen/simulador_fig_c6.jpg}
	\caption [Conexión del Simulador J1939.]{Conexión del Simulador J1939 \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{simulador_ref_c6} % Etiqueta para la referencia.
\end{figure}

Se conecta el modulo Xbee receptor al puerto USB de la computadora y se inicia el software al acceder en la página web, \textbf{Figura \ref{receptor_ref_c6}},  se selecciona el sistema J1939 y con el botón escucha se va recibiendo los datos enviados. 


\begin{figure}[H]
	\centering
	\includegraphics[width=0.5\textwidth]{./Cap6imagen/receptor_fig_c6.jpg}
	\caption [Receptor ubicado en el puerto USB.]{Receptor ubicado en el puerto USB \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{receptor_ref_c6} % Etiqueta para la referencia.
\end{figure}

Se selecciona la opción datos y observamos todas las tramas J1939 que está presente en el bus, aquí se puede observar la dirección de destino y origen de los dispositivos, los 8 bytes de datos en el cual los valores FF significa que dichos datos no están disponibles, pero los demás datos distintos a FF significan que son datos reales y disponibles, también podemos observar la prioridad de los mensajes que varía entre 3 y 6 según la \textbf{Figura \ref{escucha_ref_c6}}.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/escucha_fig_c6.png}
	\caption [Datos leídos del BUS CAN J1939.]{Datos leídos del BUS CAN J1939 \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{escucha_ref_c6} % Etiqueta para la referencia.
\end{figure}


También se puede observar la frecuencia de tipos de paquetes CAN presentes en el bus, en la \textbf{Figura \ref{paquetes_ref_c6}}, los paquetes 0xF004 han sido recibidos 102 veces y los paquetes 0xFEF2 solamente 2 veces han sido captados. Hay varias Tramas CAN que el simulador nos envía y mientras van apareciendo, el hardware los va captando y a su vez enviando al camputador para su visualización. En el caso de la 


\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/paquetes_fig_c6.png}
	\caption [Tramas CAN J1939 presentes.]{Tramas CAN J1939 presentes \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{paquetes_ref_c6} % Etiqueta para la referencia.
\end{figure}




En la \textbf{Figura \ref{real_ref_c6}} siguiente podemos observar la distribución de los datos aleatorios que van dejando el simulador en el bus, en este caso pertenece a la velocidad  del vehículo. Se puede ver la forma en la cual el simulador distribuye los datos con el tiempo.  Los datos van ingresando y el programa ajusta la gráfica para que quepan todos los datos y se pueda observar su comportamiento.  

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/real_fig_c6.png}
	\caption [Datos de Velocidad del BUS CAN J1939.]{Datos de velocidad del BUS CAN J1939 \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{real_ref_c6} % Etiqueta para la referencia.
\end{figure}


En la \textbf{Figura \ref{gauge_ref_c6}} observamos una visualización en formato de tablero, para visualizar los datos manera familiar a la de un tablero de vehículo. 
Para obtenerlo, presionamos velocidad y luego activar, para poder filtrar de entre todas las tramas la trama que contiene los datos de la velocidad, se observa una captura de velocidad de 158 metros por segundo. 


\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/gauge_fig_c6.png}
	\caption [Tablero de Velocidad J1939.]{Tablero de velocidad J1939 \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{gauge_ref_c6} % Etiqueta para la referencia.
\end{figure}

Para el sistema OBD II fue puesta a prueba el sistema en tres vehículos de las marcas Toyota 2019, Hyundai Creta 2021 y Hyundai Tucson 2011, en donde se realizó las medidas de distintos sensores para obtener datos de revoluciones por minuto del motor, voltaje de batería, velocidad y lectura de lista de sensores presentes en el vehículo,etc. Se puede ver en las \textbf{Figuras \ref{auto_ref_c6}, \ref{creta_ref_c6} y \ref{tucson_ref_c6} }  las imágenes de los tipos de vehículo automotor usados en las pruebas. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/auto_fig_c6.jpg}
	\caption [Vehículo utilizado para la Prueba OBD II.]{Vehículo utilizado para la Prueba OBD II \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{auto_ref_c6} % Etiqueta para la referencia.
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/creta_fig_c6.jpg}
	\caption [Vehículo Creta 2021 utilizado para la Prueba OBD II.]{Vehículo Creta 2021 utilizado para la Prueba OBD II \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{creta_ref_c6} % Etiqueta para la referencia.
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/tucson_fig_c6.jpg}
	\caption [Vehículo Tucson 2011 utilizado para la Prueba OBD II.]{Vehículo Tucson 2011 utilizado para la Prueba OBD II \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{tucson_ref_c6} % Etiqueta para la referencia.
\end{figure}

En la \textbf{Figura\ref{panel_ref_c6}}observamos las consultas soportadas actualmente por el sistema, que son:
\begin{itemize}
    \item \textbf{Soportes PIDs}: presenta la lista de sensores del vehículo. 
    \item \textbf{Consulta PID}: sirve para consultar sensores que no soporta el sistema de visualización pero podemos leer la codificación. 
    \item \textbf{Revoluciones}: sirve para visualizar las revoluciones por minuto del motor vehicular.
    \item \textbf{Batería, Temperatura y velocidad} son otras visualizaciones soportadas.     
\end{itemize}



\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/soportes_fig_c6.png}
	\caption [Panel Principla OBD II.]{Panel Principal OBD II \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{panel_ref_c6} % Etiqueta para la referencia.
\end{figure}



En la \textbf{ Figura\ref{consola_ref_c6}} se pueden ver en modo consola las lecturas de algunos sensores del vehículo Toyota como las revoluciones por minuto, velocidad, niveles de batería y otros. Para el momento de la captura de imagen el sistema indicaba mediciones de rpm (revoluciones por minuto) del motor. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/consola_fig_c6.png}
	\caption [Datos recibidos del Vehículo.]{Datos recibidos del Vehículo \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{consola_ref_c6} % Etiqueta para la referencia.
\end{figure}


 Se realizó una lectura de medición de temperatura del aceite de motor en reposo, es decir,  antes de arrancar el motor del vehículo, se observó la siguiente medición que se muestra en la \textbf{Figura \ref{temp_ref_c6}}. La medida fue de 38 grados Celsius, la misma se presenta con un termómetro animado del lado izquierdo y el valor númerico del lado derecho.
 
 \begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/temp_fig_c6.png}
	\caption [Visualización de la medida del sensor de temperatura de aceite del motor en reposo.]{Visualización de la medida del sensor de temperatura de aceite del motor en reposo \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{temp_ref_c6} % Etiqueta para la referencia.
\end{figure}

Otra medida de prueba fueron las revoluciones por minuto en estado de reposo, pero con el vehículo encendido, se observa en la \textbf{Figura \ref{rpm_ref_c6}} la lectura obtenida de 872 rpm del motor del vehículo, nuevamente en dos formatos para una lectura familiarizada con el tablero analógico de un vehículo y otra digitalmente. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/rpm_fig_c6.png}
	\caption [Visualización de la medida del sensor de revoluciones por minuto con el motor en reposo.]{Visualización de la medida del sensor de revoluciones por minuto con el motor en reposo.  \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{rpm_ref_c6} % Etiqueta para la referencia.
\end{figure}


Para el vehículo modelo \textbf{Tucson 2011} se realizaron las pruebas de: 


\begin{itemize}
    \item lista de algunos sensores presentes en el vehículo
    \item Sensor de velocidad
    \item Voltaje de Batería en contacto marca una tensión de 12V y una vez encendido el motor marca una tensión de 14V, con lo cuál se puede concluir que son lecturas coherentes, pues el generador está activo y recargando la batería del vehículo. 
    \item Medida de revoluciones por minuto del motor en estado de reposo. 
    \item tiempo de encendido del motor
\end{itemize}

Algunas de estas  mediciones se muestran en la \textbf{Figura \ref{dash_ref_c6}}, además de una muestra por consola de los datos recibidos del hardware. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/dash_fig_c6.jpg}
	\caption [Visualización de varias medidas de sensores.]{Visualización de varias medidas de sensores.  \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{dash_ref_c6} % Etiqueta para la referencia.
\end{figure}


El sistema provee una manera de leer los sensores que el hardware no tiene programado para hacerlo. Esto se realiza enviando el código PID deseado y  se traslada el calculo de la trama CAN al cliente. 
Para el ejemplo se realiza la lectura del temporizador del vehículo, el cual nos indica el tiempo que lleva encendido el automotor. 
Para ello se consulta el documento SAE J1979, se observa el código PID y la formula requerida de lectura del temporizador, estos datos se introducen en el sistema mediante la interfaz gráfica, \textbf{Figura \ref{consulta_ref_c6}}, una vez presionado el botón \"activar\", el software dibuja  una gráfica en el tiempo de los valores de la consulta. En la \textbf{Figura \ref{grafica_ref_c6}} se observa la lectura del temporizador en el tiempo indicando que el automóvil lleva encendido 650 segundos. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/consulta_fig_c6.png}
	\caption [Visualización de varias medidas de sensores.]{Visualización de varias medidas de sensores.  \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{consulta_ref_c6} % Etiqueta para la referencia.
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{./Cap6imagen/grafica_fig_c6.jpg}
	\caption [Visualización de varias medidas de sensores.]{Visualización de varias medidas de sensores.  \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{grafica_ref_c6} % Etiqueta para la referencia.
\end{figure}

Para el automotor modelo \textbf{Creta 2021} además de leer los mismos datos anteriores, se realizó una prueba en movimiento para medir los datos de los sensores de velocidad. La lectura se visualiza en la \textbf{Figura \ref{vel_ref_c6}} en dónde se compara con el tablero del vehículo.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{./Cap6imagen/vel_fig_c6.png}
	\caption [Comparación de la medida de Velocidad en un vehículo Creta 2021.]{Comparación de la medida de Velocidad en un vehículo Creta 2021.  \textbf{ Fuente:} %\cite{cite_can_c3}.}
		Elaboración propia.}
	\label{vel_ref_c6} % Etiqueta para la referencia.
\end{figure}

Con estas pruebas se lograron la lectura de los sensores básicos presentes en los vehículos. 